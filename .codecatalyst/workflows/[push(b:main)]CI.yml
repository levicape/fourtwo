########################################
# THIS FILE WAS AUTOMATICALLY GENERATED, DO NOT MODIFY
########################################
Name: main_OnPush__CI_CD
RunMode: QUEUED
SchemaVersion: "1.0"
Compute:
  Type: EC2
  Fleet: Linux.Arm64.XLarge
  SharedInstance: "TRUE"
Triggers:
  - Type: PUSH
    Branches:
      - main
Actions:
  ci:
    Actions:
      Install:
        Identifier: aws/build@v1.0.0
        Timeout: 5
        Caching:
          FileCaching:
            a64_npm_global:
              Path: /tmp/npm-global
              RestoreKeys:
                - npminstall
            a64_pnpm_store:
              Path: /tmp/pnpm-store
              RestoreKeys:
                - pnpminstall
            a64_pulumi:
              Path: /tmp/pulumi
              RestoreKeys:
                - pulumi
            a64_docker:
              Path: /tmp/docker-cache
              RestoreKeys:
                - docker
            a64_nx:
              Path: /tmp/nx-cache
              RestoreKeys:
                - nx
        Inputs:
          Sources:
            - WorkflowSource
          Variables:
            - Name: PAKETO_BUILDER_IMAGE
              Value: heroku/builder:24
            - Name: PULUMI_VERSION
              Value: 3.144.1
            - Name: NPM_REGISTRY_PROTOCOL
              Value: https
            - Name: NPM_REGISTRY_HOST
              Value: npm.pkg.github.com
            - Name: NODE_AUTH_TOKEN
              Value: ${Secrets.GITHUB_LEVICAPE_PAT}
        Configuration:
          Container:
            Registry: CODECATALYST
            Image: CodeCatalystLinux_Arm64:2024_03
          Steps:
            - Run: npm config set prefix=/tmp/npm-global
            - Run: npm config set @levicape:registry=$NPM_REGISTRY_PROTOCOL://$NPM_REGISTRY_HOST --location project
            - Run: npm config set //$NPM_REGISTRY_HOST/:_authToken=$NODE_AUTH_TOKEN --location project
            - Run: mkdir -p /tmp/pulumi
            - Run: mkdir -p /tmp/npm-global
            - Run: mkdir -p /tmp/pnpm-store
            - Run: mkdir -p /tmp/docker-cache/images
            - Run: docker load --input /tmp/docker-cache/images/builder.tar || true
            - Run: docker pull $PAKETO_BUILDER_IMAGE
            - Run: docker save -o /tmp/docker-cache/images/builder.tar $PAKETO_BUILDER_IMAGE
            - Run: npm root -g
            - Run: npm install --g pnpm
            - Run: npm install --g n
            - Run: npm exec n 22
            - Run: ls -la /tmp/npm-global/lib/node_modules
            - Run: ls -la /tmp/npm-global/lib/node_modules/pnpm || true
            - Run: npm exec pnpm config set store-dir /tmp/pnpm-store
            - Run: npm exec pnpm install
            - Run: npm exec pnpm list
            - Run: "[ -f /tmp/pulumi/bin/pulumi ] && /tmp/pulumi/bin/pulumi version | grep $PULUMI_VERSION || curl -fsSL https://get.pulumi.com | sh -s -- --version $PULUMI_VERSION --install-root /tmp/pulumi"
      Compile:
        Identifier: aws/build@v1.0.0
        DependsOn:
          - Install
        Timeout: 8
        Caching:
          FileCaching:
            a64_npm_global:
              Path: /tmp/npm-global
              RestoreKeys:
                - npminstall
            a64_pnpm_store:
              Path: /tmp/pnpm-store
              RestoreKeys:
                - pnpminstall
            a64_pulumi:
              Path: /tmp/pulumi
              RestoreKeys:
                - pulumi
            a64_docker:
              Path: /tmp/docker-cache
              RestoreKeys:
                - docker
            a64_nx:
              Path: /tmp/nx-cache
              RestoreKeys:
                - nx
        Configuration:
          Container:
            Registry: CODECATALYST
            Image: CodeCatalystLinux_Arm64:2024_03
          Steps:
            - Run: npm config set prefix=/tmp/npm-global
            - Run: npm exec pnpm config set store-dir /tmp/pnpm-store
            - Run: npm exec n 22
            - Run: npm exec pnpm list
            - Run: npm exec pnpm compile
            - Run: npm exec pnpm lint
      Test:
        Identifier: aws/managed-test@v1.0.0
        Timeout: 10
        Caching:
          FileCaching:
            a64_npm_global:
              Path: /tmp/npm-global
              RestoreKeys:
                - npminstall
            a64_pnpm_store:
              Path: /tmp/pnpm-store
              RestoreKeys:
                - pnpminstall
            a64_pulumi:
              Path: /tmp/pulumi
              RestoreKeys:
                - pulumi
            a64_docker:
              Path: /tmp/docker-cache
              RestoreKeys:
                - docker
            a64_nx:
              Path: /tmp/nx-cache
              RestoreKeys:
                - nx
        DependsOn:
          - Compile
        Configuration:
          Container:
            Registry: CODECATALYST
            Image: CodeCatalystLinux_Arm64:2024_03
          Steps:
            - Run: npm config set prefix=/tmp/npm-global
            - Run: npm exec pnpm config set store-dir /tmp/pnpm-store
            - Run: npm exec n 22
            - Run: npm exec pnpm list
            - Run: npm exec pnpm test
  cd:
    DependsOn:
      - ci
    Actions:
      Image:
        Identifier: aws/build@v1.0.0
        Timeout: 10
        Caching:
          FileCaching:
            a64_npm_global:
              Path: /tmp/npm-global
              RestoreKeys:
                - npminstall
            a64_pnpm_store:
              Path: /tmp/pnpm-store
              RestoreKeys:
                - pnpminstall
            a64_pulumi:
              Path: /tmp/pulumi
              RestoreKeys:
                - pulumi
            a64_docker:
              Path: /tmp/docker-cache
              RestoreKeys:
                - docker
            a64_nx:
              Path: /tmp/nx-cache
              RestoreKeys:
                - nx
        Inputs:
          Variables:
            - Name: APPLICATION_IMAGE_NAME
              Value: fourtwo
        Configuration:
          Container:
            Registry: CODECATALYST
            Image: CodeCatalystLinux_Arm64:2024_03
          Steps:
            - Run: docker load --input /tmp/docker-cache/images/builder.tar || true
            - Run: mkdir -p /.artifacts
            - Run: npm config set prefix=/tmp/npm-global
            - Run: npm exec pnpm config set store-dir /tmp/pnpm-store
            - Run: npm exec n 22
            - Run: npm exec pnpm exec nx pack:build iac-images-application --verbose
            - Run: docker save -o $(pwd)/.artifacts/application.tar $APPLICATION_IMAGE_NAME
      Preview_current:
        Identifier: aws/build@v1.0.0
        DependsOn:
          - Image
        Timeout: 10
        Environment:
          Name: current
        Caching:
          FileCaching:
            a64_npm_global:
              Path: /tmp/npm-global
              RestoreKeys:
                - npminstall
            a64_pnpm_store:
              Path: /tmp/pnpm-store
              RestoreKeys:
                - pnpminstall
            a64_pulumi:
              Path: /tmp/pulumi
              RestoreKeys:
                - pulumi
            a64_docker:
              Path: /tmp/docker-cache
              RestoreKeys:
                - docker
            a64_nx:
              Path: /tmp/nx-cache
              RestoreKeys:
                - nx
        Inputs:
          Variables:
            - Name: CI_ENVIRONMENT
              Value: current
            - Name: CI_REGION
              Value: us-west-2
        Configuration:
          Container:
            Registry: CODECATALYST
            Image: CodeCatalystLinux_Arm64:2024_03
          Steps:
            - Run: docker load --input $(pwd)/.artifacts/application.tar
            - Run: docker images
            - Run: aws ssm get-parameter --name /fourtwo/_principal/pulumi/backend/StateBackendCommandReference
            - Run: docker run --rm -e CI=true -e AWS_EXECUTION_ENV -e AWS_CONTAINER_CREDENTIALS_FULL_URI --network="host" --entrypoint launcher fourtwo -- pnpm run dx:cli:mjs aws pulumi ci --region us-west-2 > .pulumi-ci
            - Run: cat .pulumi-ci
            - Run: /tmp/pulumi/bin/pulumi stack init $CI_ENVIRONMENT -C iac/stacks/code
            - Run: /tmp/pulumi/bin/pulumi preview -C iac/stacks/code
            - Run: /tmp/pulumi/bin/pulumi stack init $CI_ENVIRONMENT -C iac/stacks/domain
            - Run: /tmp/pulumi/bin/pulumi preview -C iac/stacks/domain
            - Run: /tmp/pulumi/bin/pulumi stack init $CI_ENVIRONMENT -C iac/stacks/environment
            - Run: /tmp/pulumi/bin/pulumi preview -C iac/stacks/environment
            - Run: /tmp/pulumi/bin/pulumi stack init $CI_ENVIRONMENT -C iac/stacks/platform
            - Run: /tmp/pulumi/bin/pulumi preview -C iac/stacks/platform
            - Run: /tmp/pulumi/bin/pulumi stack init $CI_ENVIRONMENT -C iac/stacks/schedule
            - Run: /tmp/pulumi/bin/pulumi preview -C iac/stacks/schedule
            - Run: /tmp/pulumi/bin/pulumi stack init $CI_ENVIRONMENT -C iac/stacks/test
            - Run: /tmp/pulumi/bin/pulumi preview -C iac/stacks/test
            - Run: /tmp/pulumi/bin/pulumi stack init $CI_ENVIRONMENT -C iac/stacks/website
            - Run: /tmp/pulumi/bin/pulumi preview -C iac/stacks/website

########################################
########################################
#**:_$~- {"$$":"head","filename":"[push(b:main)]CI.yml","source":"iac/workflows/codecatalyst/push/CI.js"}
#**:_$~- {"$$":"script","generator":"codegen/codecatalyst/GenerateCodeCatalystWorkflow.mts"}
#**:_$~- {"$$":"body","hashed":"88a4410d781fb89c5ef00ab9844b8ea2b3eebc2d80cd2a9c9e082ea708a97938"}
#**:_$~- {"$$":"footer","started":"2025-01-05T00:11:10.611Z","now":"2025-01-05T00:11:10.617Z","elapsed":"6ms"}
# END OF GENERATED FILE

