########################################
# THIS FILE WAS AUTOMATICALLY GENERATED, DO NOT MODIFY
########################################
Name: main_OnPush__CI_CD
RunMode: QUEUED
SchemaVersion: "1.0"
Compute:
  Type: EC2
  Fleet: Linux.Arm64.2XLarge
Triggers:
  - Type: PUSH
    Branches:
      - main
Actions:
  Integration:
    Actions:
      Install:
        Identifier: aws/build@v1.0.0
        Timeout: 9
        Caching:
          FileCaching:
            a64_npm_global:
              Path: /tmp/npm-global
              RestoreKeys:
                - npminstall
            a64_pnpm_store:
              Path: /tmp/pnpm-store
              RestoreKeys:
                - pnpminstall
            a64_nx:
              Path: /tmp/nx-cache
              RestoreKeys:
                - nx
            a64_docker:
              Path: /tmp/docker-cache
              RestoreKeys:
                - docker
            a64_pulumi:
              Path: /tmp/pulumi
              RestoreKeys:
                - pulumi
        Inputs:
          Sources:
            - WorkflowSource
          Variables:
            - Name: PAKETO_CLI_IMAGE
              Value: buildpacksio/pack:latest
            - Name: PAKETO_BUILDER_IMAGE
              Value: heroku/builder:24
            - Name: PAKETO_LAUNCHER_IMAGE
              Value: heroku/heroku:24
            - Name: PULUMI_VERSION
              Value: 3.144.1
            - Name: NPM_REGISTRY_PROTOCOL
              Value: https
            - Name: NPM_REGISTRY_HOST
              Value: npm.pkg.github.com
            - Name: NODE_AUTH_TOKEN
              Value: ${Secrets.GITHUB_LEVICAPE_PAT}
        Outputs:
          Artifacts:
            - Name: node_modules
              Files:
                - node_modules/**/*
                - "**/node_modules/**/*"
        Configuration:
          Container:
            Registry: CODECATALYST
            Image: CodeCatalystLinux_Arm64:2024_03
          Steps:
            - Run: npm config set prefix=/tmp/npm-global
            - Run: npm config set @levicape:registry=$NPM_REGISTRY_PROTOCOL://$NPM_REGISTRY_HOST --location project
            - Run: npm config set //$NPM_REGISTRY_HOST/:_authToken=$NODE_AUTH_TOKEN --location project
            - Run: mkdir -p /tmp/pulumi
            - Run: mkdir -p /tmp/npm-global
            - Run: mkdir -p /tmp/pnpm-store
            - Run: mkdir -p /tmp/docker-cache/images
            - Run: docker load --input /tmp/docker-cache/images/cli-pack.tar || true
            - Run: docker pull $PAKETO_CLI_IMAGE
            - Run: docker save -o /tmp/docker-cache/images/cli-pack.tar $PAKETO_CLI_IMAGE
            - Run: docker load --input /tmp/docker-cache/images/builder.tar || true
            - Run: docker pull $PAKETO_BUILDER_IMAGE
            - Run: docker save -o /tmp/docker-cache/images/builder.tar $PAKETO_BUILDER_IMAGE
            - Run: docker load --input /tmp/docker-cache/images/launcher.tar || true
            - Run: docker pull $PAKETO_LAUNCHER_IMAGE
            - Run: docker save -o /tmp/docker-cache/images/launcher.tar $PAKETO_LAUNCHER_IMAGE
            - Run: npm root -g
            - Run: npm install --g pnpm
            - Run: npm install --g n
            - Run: npm exec n 22
            - Run: ls -la /tmp/npm-global/lib/node_modules
            - Run: ls -la /tmp/npm-global/lib/node_modules/pnpm || true
            - Run: npm exec pnpm config set store-dir /tmp/pnpm-store
            - Run: npm exec pnpm install
            - Run: npm exec pnpm list
            - Run: "[ -f /tmp/pulumi/bin/pulumi ] && /tmp/pulumi/bin/pulumi version | grep $PULUMI_VERSION || curl -fsSL https://get.pulumi.com | sh -s -- --version $PULUMI_VERSION --install-root /tmp/pulumi"
      Compile:
        Identifier: aws/build@v1.0.0
        DependsOn:
          - Install
        Timeout: 8
        Caching:
          FileCaching:
            a64_npm_global:
              Path: /tmp/npm-global
              RestoreKeys:
                - npminstall
            a64_pnpm_store:
              Path: /tmp/pnpm-store
              RestoreKeys:
                - pnpminstall
            a64_nx:
              Path: /tmp/nx-cache
              RestoreKeys:
                - nx
        Inputs:
          Sources:
            - WorkflowSource
          Artifacts:
            - node_modules
        Outputs:
          AutoDiscoverReports:
            Enabled: true
            ReportNamePrefix: junit
        Configuration:
          Container:
            Registry: CODECATALYST
            Image: CodeCatalystLinux_Arm64:2024_03
          Steps:
            - Run: npm config set prefix=/tmp/npm-global
            - Run: npm exec n 22
            - Run: npm exec pnpm install --offline
            - Run: npm exec pnpm compile
            - Run: npm exec pnpm lint
            - Run: npm exec pnpm test
      Image:
        Identifier: aws/build@v1.0.0
        DependsOn:
          - Install
        Timeout: 10
        Caching:
          FileCaching:
            a64_npm_global:
              Path: /tmp/npm-global
              RestoreKeys:
                - npminstall
            a64_pnpm_store:
              Path: /tmp/pnpm-store
              RestoreKeys:
                - pnpminstall
            a64_nx:
              Path: /tmp/nx-cache
              RestoreKeys:
                - nx
            a64_docker:
              Path: /tmp/docker-cache
              RestoreKeys:
                - docker
        Inputs:
          Sources:
            - WorkflowSource
          Variables:
            - Name: APPLICATION_IMAGE_NAME
              Value: fourtwo
          Artifacts:
            - node_modules
        Outputs:
          Artifacts:
            - Name: artifacts
              Files:
                - .artifacts/**/*
        Configuration:
          Container:
            Registry: CODECATALYST
            Image: CodeCatalystLinux_Arm64:2024_03
          Steps:
            - Run: docker load --input /tmp/docker-cache/images/cli-pack.tar || true
            - Run: docker load --input /tmp/docker-cache/images/builder.tar || true
            - Run: docker load --input /tmp/docker-cache/images/launcher.tar || true
            - Run: mkdir -p $(pwd)/.artifacts
            - Run: npm config set prefix=/tmp/npm-global
            - Run: npm exec n 22
            - Run: npm exec pnpm install --offline
            - Run: npm exec pnpm exec nx pack:build iac-images-application --verbose
            - Run: docker save -o $(pwd)/.artifacts/application.tar $APPLICATION_IMAGE_NAME
      Preview_current:
        Identifier: aws/build@v1.0.0
        DependsOn:
          - Image
        Timeout: 10
        Environment:
          Name: current
        Caching:
          FileCaching:
            a64_npm_global:
              Path: /tmp/npm-global
              RestoreKeys:
                - npminstall
            a64_pnpm_store:
              Path: /tmp/pnpm-store
              RestoreKeys:
                - pnpminstall
            a64_nx:
              Path: /tmp/nx-cache
              RestoreKeys:
                - nx
            a64_pulumi:
              Path: /tmp/pulumi
              RestoreKeys:
                - pulumi
        Inputs:
          Variables:
            - Name: APPLICATION_IMAGE_NAME
              Value: fourtwo
            - Name: CI_ENVIRONMENT
              Value: current
            - Name: CI_REGION
              Value: us-west-2
            - Name: PULUMI_CONFIG_PASSPHRASE
              Value: ${{ Secrets.PULUMI_CONFIG_PASSPHRASE }}
            - Name: PULUMI_HOME
              Value: /tmp/pulumi
          Artifacts:
            - artifacts
            - node_modules
        Configuration:
          Container:
            Registry: CODECATALYST
            Image: CodeCatalystLinux_Arm64:2024_03
          Steps:
            - Run: docker load --input $(pwd)/.artifacts/application.tar
            - Run: docker images
            - Run: aws ssm get-parameter --name /fourtwo/_principal/pulumi/backend/StateBackendCommandReference
            - Run: docker run --rm -e CI=true -e AWS_EXECUTION_ENV -e AWS_CONTAINER_CREDENTIALS_FULL_URI --network="host" --entrypoint launcher fourtwo -- pnpm run dx:cli:mjs aws pulumi ci --region us-west-2 > .pulumi-ci
            - Run: cat .pulumi-ci | grep "export PULUMI" > .pulumi-ci
            - Run: cat .pulumi-ci
            - Run: source .pulumi-ci
            - Run: /tmp/pulumi/bin/pulumi stack init --secrets-provider $PULUMI_BACKEND_KEY -C iac/stacks/code $APPLICATION_IMAGE_NAME.$CI_ENVIRONMENT.code
            - Run: /tmp/pulumi/bin/pulumi preview -C iac/stacks/code
            - Run: /tmp/pulumi/bin/pulumi stack init --secrets-provider $PULUMI_BACKEND_KEY -C iac/stacks/domain $APPLICATION_IMAGE_NAME.$CI_ENVIRONMENT.domain
            - Run: /tmp/pulumi/bin/pulumi preview -C iac/stacks/domain
            - Run: /tmp/pulumi/bin/pulumi stack init --secrets-provider $PULUMI_BACKEND_KEY -C iac/stacks/environment $APPLICATION_IMAGE_NAME.$CI_ENVIRONMENT.environment
            - Run: /tmp/pulumi/bin/pulumi preview -C iac/stacks/environment
            - Run: /tmp/pulumi/bin/pulumi stack init --secrets-provider $PULUMI_BACKEND_KEY -C iac/stacks/platform $APPLICATION_IMAGE_NAME.$CI_ENVIRONMENT.platform
            - Run: /tmp/pulumi/bin/pulumi preview -C iac/stacks/platform
            - Run: /tmp/pulumi/bin/pulumi stack init --secrets-provider $PULUMI_BACKEND_KEY -C iac/stacks/schedule $APPLICATION_IMAGE_NAME.$CI_ENVIRONMENT.schedule
            - Run: /tmp/pulumi/bin/pulumi preview -C iac/stacks/schedule
            - Run: /tmp/pulumi/bin/pulumi stack init --secrets-provider $PULUMI_BACKEND_KEY -C iac/stacks/test $APPLICATION_IMAGE_NAME.$CI_ENVIRONMENT.test
            - Run: /tmp/pulumi/bin/pulumi preview -C iac/stacks/test
            - Run: /tmp/pulumi/bin/pulumi stack init --secrets-provider $PULUMI_BACKEND_KEY -C iac/stacks/website $APPLICATION_IMAGE_NAME.$CI_ENVIRONMENT.website
            - Run: /tmp/pulumi/bin/pulumi preview -C iac/stacks/website

########################################
########################################
#**:_$~- {"$$":"head","filename":"[push(b:main)]CI.yml","source":"iac/workflows/codecatalyst/push/CI.js"}
#**:_$~- {"$$":"script","generator":"codegen/codecatalyst/GenerateCodeCatalystWorkflow.mts"}
#**:_$~- {"$$":"body","hashed":"a00c8f67a4d6b3a94a83ca255962298f5f68103b9f860eb8bd089b4059b5228c"}
#**:_$~- {"$$":"footer","started":"2025-01-06T06:13:10.964Z","now":"2025-01-06T06:13:10.970Z","elapsed":"6ms"}
# END OF GENERATED FILE

