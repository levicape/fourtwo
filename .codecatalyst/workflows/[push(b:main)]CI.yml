########################################
# THIS FILE WAS AUTOMATICALLY GENERATED, DO NOT MODIFY
########################################
Name: main_OnPush__CI_CD
RunMode: QUEUED
SchemaVersion: "1.0"
Compute:
  Type: EC2
  Fleet: Linux.Arm64.XLarge
  SharedInstance: "TRUE"
Triggers:
  - Type: PUSH
    Branches:
      - main
Actions:
  ci:
    Actions:
      Install:
        Identifier: aws/build@v1.0.0
        Timeout: 5
        Caching:
          FileCaching:
            a64_npm_global:
              Path: .npm-global
              RestoreKeys:
                - npminstall
            a64_pnpm_store:
              Path: .pnpm-store
              RestoreKeys:
                - pnpminstall
            a64_pulumi:
              Path: .pulumi
              RestoreKeys:
                - pulumi
            a64_docker:
              Path: .docker-cache
              RestoreKeys:
                - docker
            a64_nx:
              Path: .nx
              RestoreKeys:
                - nx
        Inputs:
          Sources:
            - WorkflowSource
          Variables:
            - Name: NPM_REGISTRY_PROTOCOL
              Value: https
            - Name: NPM_REGISTRY_HOST
              Value: npm.pkg.github.com
            - Name: NODE_AUTH_TOKEN
              Value: ${Secrets.GITHUB_LEVICAPE_PAT}
        Configuration:
          Container:
            Registry: CODECATALYST
            Image: CodeCatalystLinux_Arm64:2024_03
          Steps:
            - Run: npm config set prefix=$(pwd)/.npm-global
            - Run: npm config set @levicape:registry=$NPM_REGISTRY_PROTOCOL://$NPM_REGISTRY_HOST --location project
            - Run: npm config set //$NPM_REGISTRY_HOST/:_authToken=$NODE_AUTH_TOKEN --location project
            - Run: mkdir -p ./.pulumi
            - Run: mkdir -p ./.npm-global
            - Run: mkdir -p ./.pnpm-store
            - Run: mkdir -p ./.docker-cache
            - Run: npm root -g
            - Run: npm install --g pnpm
            - Run: npm install --g n
            - Run: npm exec n 22
            - Run: ls -la ./.npm-global/lib/node_modules
            - Run: ls -la ./.npm-global/lib/node_modules/pnpm || true
            - Run: npm exec pnpm config set store-dir $(pwd)/.pnpm-store
            - Run: npm exec pnpm install
            - Run: npm exec pnpm list
            - Run: curl -fsSL https://get.pulumi.com | sh -s -- --install-root $(pwd)/.pulumi
      Compile:
        Identifier: aws/build@v1.0.0
        DependsOn:
          - Install
        Timeout: 8
        Configuration:
          Container:
            Registry: CODECATALYST
            Image: CodeCatalystLinux_Arm64:2024_03
          Steps:
            - Run: npm config set prefix=$(pwd)/.npm-global
            - Run: npm exec pnpm config set store-dir $(pwd)/.pnpm-store
            - Run: npm exec n 22
            - Run: npm exec pnpm list
            - Run: npm exec pnpm compile
            - Run: npm exec pnpm lint
      Test:
        Identifier: aws/managed-test@v1.0.0
        Timeout: 10
        DependsOn:
          - Compile
        Configuration:
          Container:
            Registry: CODECATALYST
            Image: CodeCatalystLinux_Arm64:2024_03
          Steps:
            - Run: npm config set prefix=$(pwd)/.npm-global
            - Run: npm exec pnpm config set store-dir $(pwd)/.pnpm-store
            - Run: npm exec n 22
            - Run: npm exec pnpm list
            - Run: npm exec pnpm test
  cd:
    DependsOn:
      - ci
    Actions:
      Image:
        Identifier: aws/build@v1.0.0
        Timeout: 10
        Configuration:
          Container:
            Registry: CODECATALYST
            Image: CodeCatalystLinux_Arm64:2024_03
          Steps:
            - Run: npm config set prefix=$(pwd)/.npm-global
            - Run: npm exec pnpm config set store-dir $(pwd)/.pnpm-store
            - Run: npm exec n 22
            - Run: npm exec pnpm exec nx pack:build iac-images-application --verbose
      Preview_current:
        Identifier: aws/build@v1.0.0
        DependsOn:
          - Image
        Timeout: 10
        Environment:
          Name: current
        Inputs:
          Variables:
            - Name: CI_ENVIRONMENT
              Value: current
            - Name: CI_REGION
              Value: us-west-2
        Configuration:
          Container:
            Registry: CODECATALYST
            Image: CodeCatalystLinux_Arm64:2024_03
          Steps:
            - Run: docker images
            - Run: aws ssm get-parameter --name /fourtwo/_principal/pulumi/backend/StateBackendBucketName
            - Run: docker run --rm -e CI=true -e AWS_EXECUTION_ENV -e AWS_CONTAINER_CREDENTIALS_FULL_URI --network="host" --entrypoint launcher fourtwo -- pnpm run dx:cli:mjs aws pulumi ci --region us-west-2
            - Run: cat .pulumi-ci
            - Run: ./.pulumi/bin/pulumi stack init $CI_ENVIRONMENT -C iac/stacks/code
            - Run: ./.pulumi/bin/pulumi preview -C iac/stacks/code
            - Run: ./.pulumi/bin/pulumi stack init $CI_ENVIRONMENT -C iac/stacks/domain
            - Run: ./.pulumi/bin/pulumi preview -C iac/stacks/domain
            - Run: ./.pulumi/bin/pulumi stack init $CI_ENVIRONMENT -C iac/stacks/environment
            - Run: ./.pulumi/bin/pulumi preview -C iac/stacks/environment
            - Run: ./.pulumi/bin/pulumi stack init $CI_ENVIRONMENT -C iac/stacks/platform
            - Run: ./.pulumi/bin/pulumi preview -C iac/stacks/platform
            - Run: ./.pulumi/bin/pulumi stack init $CI_ENVIRONMENT -C iac/stacks/schedule
            - Run: ./.pulumi/bin/pulumi preview -C iac/stacks/schedule
            - Run: ./.pulumi/bin/pulumi stack init $CI_ENVIRONMENT -C iac/stacks/test
            - Run: ./.pulumi/bin/pulumi preview -C iac/stacks/test
            - Run: ./.pulumi/bin/pulumi stack init $CI_ENVIRONMENT -C iac/stacks/website
            - Run: ./.pulumi/bin/pulumi preview -C iac/stacks/website

########################################
########################################
#**:_$~- {"$$":"head","filename":"[push(b:main)]CI.yml","source":"iac/workflows/codecatalyst/push/CI.js"}
#**:_$~- {"$$":"script","generator":"codegen/codecatalyst/GenerateCodeCatalystWorkflow.mts"}
#**:_$~- {"$$":"body","hashed":"1797429b133694e861595855d1114d5537e66d17600fcd9d440e6583d1a894a7"}
#**:_$~- {"$$":"footer","started":"2025-01-04T21:31:41.832Z","now":"2025-01-04T21:31:41.838Z","elapsed":"6ms"}
# END OF GENERATED FILE

